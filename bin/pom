#!/usr/bin/env node
var timer   = require('daemonize2');
var command = require('commander');
var version = require('../package.json').version;
var fs = require('fs');

var conf = {
    main: 'daemon',
    name: 'pom',
    pidfile: '/tmp/pom.pid',
    silent: true
};

command.version(version);
command.option('-b, --break', 'break')

command
    .command('start')
    .description('start pomodoro timer')
    .action(function(){
        conf.argv = command.break ? 'break' : 'pomodoro';
        timer.setup(conf).start();
        console.log('pomodoro start');
    });

command
    .command('status')
    .description('check the status of pomodoro timer')
    .action(function(){
        var isRunning = timer.setup(conf).status();
        if (isRunning) {
            fs.stat(conf.pidfile, function(err, stats) {
                if (err) {
                    console.log(err);
                } else {
                    var startTime = stats.ctime;
                    var now = new Date();
                    var secondsDiff = (now.getTime() - startTime.getTime())/1000;
                    var minutesLeft = 25 - Math.floor(secondsDiff / 60);
                    console.log('Pomodoro ticking! ' + minutesLeft + " minutes left.");
                }
            })
        } else {
            console.log('No pomodoro running');
        }
    });

command
    .command('stop')
    .description('stop pomodoro timer')
    .action(function(){
        timer.setup(conf).stop();
        console.log('pomodoro stop');
    });

command.parse(process.argv);

if (!command.args.length) command.help();
